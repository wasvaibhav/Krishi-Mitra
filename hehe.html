<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡§ï‡•É‡§∑‡§ø ‡§Æ‡§ø‡§§‡•ç‡§∞ ‚Äî ‡§ñ‡§æ‡§¶ ‡§∏‡§≤‡§æ‡§π (‡§µ‡•â‡§á‡§∏ + ‡§Æ‡•å‡§∏‡§Æ + ‡§∞‡§æ‡§ú‡•ç‡§Ø)</title>
  <style>
    *{box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;background:#f0fff0;margin:0;color:#1b3a2b}
    header{background:linear-gradient(90deg,#2e7d32,#4caf50);color:#fff;padding:18px;text-align:center;font-size:22px;font-weight:700}
    .page{max-width:920px;margin:18px auto;padding:18px}
    .card{background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:14px}
    label{display:block;font-weight:700;margin-top:10px}
    select,input{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #dcdcdc;font-size:16px}
    .row{display:flex;gap:10px}
    .col{flex:1}
    .small{width:140px}
    .btn{background:#ff9800;color:#fff;border:none;padding:12px 14px;border-radius:8px;font-weight:700;cursor:pointer;margin-top:12px}
    .btn:hover{background:#f57c00}
    .mic{width:80px;height:80px;border-radius:50%;background:#2196f3;color:#fff;border:none;font-size:28px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;margin:12px auto}
    .mic.listening{background:#d32f2f}
    .result{background:#e8f5e9;border-left:6px solid #2e7d32;padding:12px;border-radius:6px;margin-top:12px;font-size:18px}
    .muted{color:#666;font-size:14px}
    .inline{display:inline-block;vertical-align:middle}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:14px}
    @media(max-width:920px){.grid{grid-template-columns:1fr}}
    .warn{color:#b00020;font-weight:700}
    .small-note{font-size:13px;color:#666;margin-top:8px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    td,th{padding:8px;border:1px solid #eee;text-align:left;font-size:15px}
    .muted-block{background:#fff8e1;padding:10px;border-radius:8px;margin-top:8px;color:#6b4b00}
    .back-btn {
  position: absolute;
  top: 14px;
  right: 14px;
  background: #ffffff22;
  color: #fff;
  border: 1px solid #ffffff44;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.3s;
}
.back-btn:hover {
  background: #ffffff44;
}
  </style>
</head>
<body>
<header>
  üåæ ‡§ï‡•É‡§∑‡§ø ‡§Æ‡§ø‡§§‡•ç‡§∞ ‚Äî ‡§ñ‡§æ‡§¶ ‡§∏‡§≤‡§æ‡§π (‡§µ‡•â‡§á‡§∏ + ‡§Æ‡•å‡§∏‡§Æ + ‡§∞‡§æ‡§ú‡•ç‡§Ø)
  <button class="back-btn" onclick="goBack()">‚¨ÖÔ∏è Back</button>
</header>

<main class="page">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-weight:800;font-size:18px">‡§∏‡§∞‡§≤ ‡§ñ‡§æ‡§¶ ‡§∏‡§≤‡§æ‡§π (‡§≠‡§æ‡§∞‡§§) ‚Äî ‡§∞‡§æ‡§ú‡•ç‡§Ø ‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§´‡§∏‡§≤ ‡§∏‡•Ç‡§ö‡•Ä</div>
        <div class="small-note">‡§™‡§π‡§≤‡•á ‡§∞‡§æ‡§ú‡•ç‡§Ø ‡§ö‡•Å‡§®‡•á‡§Ç, ‡§´‡§ø‡§∞ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§°‡§æ‡§≤‡•á‡§Ç ‡§î‡§∞ ‡§â‡§∏ ‡§∞‡§æ‡§ú‡•ç‡§Ø ‡§ï‡•Ä ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§´‡§∏‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç ‚Äî ‡§Ø‡§æ ‡§µ‡•â‡§á‡§∏ ‡§∏‡•á ‡§¨‡§§‡§æ‡§è‡§Ç‡•§</div>
      </div>
    </div>

    <div style="margin-top:12px" class="grid">
      <!-- LEFT: form -->
      <div>
        <label for="state">‡§∞‡§æ‡§ú‡•ç‡§Ø ‡§ö‡•Å‡§®‡•á‡§Ç</label>
        <select id="state">
          <option value="">-- ‡§Ö‡§™‡§®‡§æ ‡§∞‡§æ‡§ú‡•ç‡§Ø ‡§ö‡•Å‡§®‡•á‡§Ç --</option>
          <option value="uttar_pradesh">‡§â‡§§‡•ç‡§§‡§∞ ‡§™‡•ç‡§∞‡§¶‡•á‡§∂</option>
          <option value="maharashtra">‡§Æ‡§π‡§æ‡§∞‡§æ‡§∑‡•ç‡§ü‡•ç‡§∞</option>
          <option value="bihar">‡§¨‡§ø‡§π‡§æ‡§∞</option>
          <option value="west_bengal">‡§™‡§∂‡•ç‡§ö‡§ø‡§Æ ‡§¨‡§Ç‡§ó‡§æ‡§≤</option>
          <option value="madhya_pradesh">‡§Æ‡§ß‡•ç‡§Ø ‡§™‡•ç‡§∞‡§¶‡•á‡§∂</option>
          <option value="tamil_nadu">‡§§‡§Æ‡§ø‡§≤ ‡§®‡§æ‡§°‡•Å</option>
          <option value="karnataka">‡§ï‡§∞‡•ç‡§®‡§æ‡§ü‡§ï</option>
          <option value="gujarat">‡§ó‡•Å‡§ú‡§∞‡§æ‡§§</option>
          <option value="rajasthan">‡§∞‡§æ‡§ú‡§∏‡•ç‡§•‡§æ‡§®</option>
          <option value="andhra_pradesh">‡§Ü‡§Ç‡§ß‡•ç‡§∞ ‡§™‡•ç‡§∞‡§¶‡•á‡§∂</option>
          <option value="odisha">‡§ì‡§°‡§ø‡§∂‡§æ</option>
          <option value="telangana">‡§§‡•á‡§≤‡§Ç‡§ó‡§æ‡§®‡§æ</option>
          <option value="assam">‡§Ö‡§∏‡§Æ</option>
          <option value="punjab">‡§™‡§Ç‡§ú‡§æ‡§¨</option>
          <option value="haryana">‡§π‡§∞‡§ø‡§Ø‡§æ‡§£‡§æ</option>
          <option value="kerala">‡§ï‡•á‡§∞‡§≤</option>
          <option value="jammu_kashmir">‡§ú‡§Æ‡•ç‡§Æ‡•Ç ‡§î‡§∞ ‡§ï‡§∂‡•ç‡§Æ‡•Ä‡§∞</option>
          <option value="uttarakhand">‡§â‡§§‡•ç‡§§‡§∞‡§æ‡§ñ‡§Ç‡§°</option>
          <option value="jharkhand">‡§ù‡§æ‡§∞‡§ñ‡§Ç‡§°</option>
          <option value="chhattisgarh">‡§õ‡§§‡•ç‡§§‡•Ä‡§∏‡§ó‡§¢‡§º</option>
          <option value="himachal_pradesh">‡§π‡§ø‡§Æ‡§æ‡§ö‡§≤ ‡§™‡•ç‡§∞‡§¶‡•á‡§∂</option>
          <option value="goa">‡§ó‡•ã‡§µ‡§æ</option>
          <option value="manipur">‡§Æ‡§£‡§ø‡§™‡•Å‡§∞</option>
          <option value="meghalaya">‡§Æ‡•á‡§ò‡§æ‡§≤‡§Ø</option>
          <option value="mizoram">‡§Æ‡§ø‡§ú‡•ã‡§∞‡§Æ</option>
          <option value="nagaland">‡§®‡§æ‡§ó‡§∞‡§≤‡•à‡§Ç‡§°</option>
          <option value="tripura">‡§§‡•ç‡§∞‡§ø‡§™‡•Å‡§∞‡§æ</option>
          <option value="sikkim">‡§∏‡§ø‡§ï‡•ç‡§ï‡§ø‡§Æ</option>
        </select>

        <label for="crop">‡§´‡§∏‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç (‡§∞‡§æ‡§ú‡•ç‡§Ø ‡§ï‡•á ‡§Ü‡§ß‡§æ‡§∞ ‡§™‡§∞ ‡§≤‡•ã‡§° ‡§π‡•ã‡§ó‡•Ä)</label>
        <select id="crop">
          <option value="">-- ‡§™‡§π‡§≤‡•á ‡§∞‡§æ‡§ú‡•ç‡§Ø ‡§ö‡•Å‡§®‡•á‡§Ç --</option>
        </select>

        <label for="area">‡§ú‡§Æ‡•Ä‡§® ‡§ï‡•Ä ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ</label>
        <div class="row">
          <input id="area" type="number" min="0" step="0.01" placeholder="‡§ú‡§Æ‡•Ä‡§® ‡§ï‡•Ä ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ (‡§ú‡•à‡§∏‡•á 2)">
          <select id="unit" class="small">
            <option value="acre">‡§è‡§ï‡§°‡§º (acre)</option>
            <option value="hectare">‡§π‡•á‡§ï‡•ç‡§ü‡•á‡§Ø‡§∞ (hectare)</option>
            <option value="bigha_punjab">‡§¨‡•Ä‡§ò‡§æ - Punjab (bigha)</option>
            <option value="bigha_up">‡§¨‡•Ä‡§ò‡§æ - UP (bigha)</option>
            <option value="nali">‡§®‡§æ‡§≤‡•Ä (nali)</option>
            <option value="other">‡§Ö‡§®‡•ç‡§Ø (‡§ï‡§∏‡•ç‡§ü‡§Æ)</option>
          </select>
        </div>

        <div id="customRow" style="display:none;margin-top:8px">
          <label>‡§ï‡§∏‡•ç‡§ü‡§Æ ‡§á‡§ï‡§æ‡§à ‚Äî 1 ‡§Ø‡•Ç‡§®‡§ø‡§ü = ‡§ï‡§ø‡§§‡§®‡•á ‡§è‡§ï‡§°‡§º?</label>
          <input id="customFactor" type="number" step="0.0001" placeholder="‡§â‡§¶‡§æ‡§π‡§∞‡§£: 0.625 (1 bigha = 0.625 acre)">
          <div class="small-note">‡§Ø‡§¶‡§ø ‡§¨‡•Ä‡§ò‡§æ ‡§∞‡§æ‡§ú‡•ç‡§Ø ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§Ö‡§≤‡§ó ‡§π‡•à ‡§§‡•ã ‡§Ø‡§π‡§æ‡§Å ‡§Æ‡§æ‡§® ‡§°‡§æ‡§≤‡•á‡§Ç, ‡§µ‡§∞‡§®‡§æ ‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü ‡§∞‡§ñ‡•á‡§Ç‡•§</div>
        </div>

        <label for="location">‡§ó‡§æ‡§Å‡§µ / ‡§∂‡§π‡§∞ / ‡§ú‡§º‡§ø‡§≤‡§æ (‡§Æ‡•å‡§∏‡§Æ ‡§ï‡•á ‡§≤‡§ø‡§è)</label>
        <input id="location" type="text" placeholder="‡§â‡§¶‡§æ‡§π‡§∞‡§£: Nainital">

        <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
          <button class="btn col" id="pauseBtn" onclick="toggleSpeech()">‚è∏Ô∏è Pause / Resume</button>
          <button class="btn col" onclick="calculateAndAdvise()">‡§∏‡§≤‡§æ‡§π ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å</button>
          <button class="mic inline" id="micBtn" title="‡§µ‡•â‡§á‡§∏ ‡§á‡§®‡§™‡•Å‡§ü" onclick="toggleListening()">üéô</button>
          <button class="btn col" onclick="window.location.href='fasal.html'">‡§´‡§∏‡§≤ ‡§¨‡•á‡§ö‡•á‡§Ç</button>
          <button class="btn col" onclick="window.location.href='beej.html'">‡§¨‡•Ä‡§ú ‡§ñ‡§∞‡•Ä‡§¶‡•á‡§Ç</button>
        </div>

        <div class="small-note">‡§Æ‡§æ‡§á‡§ï ‡§¶‡§¨‡§æ‡§ï‡§∞ ‡§¨‡•ã‡§≤‡•á ‚Äî ‡§â‡§¶‡§æ‡§π‡§∞‡§£: "‡§ó‡•á‡§π‡•Ç‡§Å 2 ‡§¨‡•Ä‡§ò‡§æ ‡§≤‡•Å‡§ß‡§ø‡§Ø‡§æ‡§®‡§æ" ‡§Ø‡§æ "‡§ß‡§æ‡§® 1.5 ‡§è‡§ï‡§°‡§º ‡§™‡§ü‡§®‡§æ"</div>
      </div>

      <!-- RIGHT: summary & weather -->
      <div>
        <div style="font-weight:800">‡§™‡§∞‡§ø‡§£‡§æ‡§Æ</div>
        <div id="resultBox" class="card" style="margin-top:10px;padding:12px;background:#fff"></div>

        <div style="margin-top:12px">
          <div style="font-weight:800">‡§Æ‡•å‡§∏‡§Æ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä</div>
          <div id="weatherBox" class="card" style="margin-top:10px;padding:12px;background:#fff">‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡•ç‡§•‡§æ‡§® ‡§°‡§æ‡§≤‡§ï‡§∞ ‡§∏‡§≤‡§æ‡§π ‡§∞‡§® ‡§ï‡§∞‡•á‡§Ç‡•§</div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div style="font-weight:800">‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä / ‡§ü‡§ø‡§™‡•ç‡§∏</div>
    <ul style="margin-top:8px">
      <li class="small-note">‡§Ø‡§π ‡§∏‡§≤‡§æ‡§π ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§Ö‡§®‡•Å‡§∂‡§Ç‡§∏‡§æ‡§ì‡§Ç ‡§™‡§∞ ‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§π‡•à; ‡§∏‡§ü‡•Ä‡§ï‡§§‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä ‡§ú‡§æ‡§Å‡§ö ‡§î‡§∞ ‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§ï‡•É‡§∑‡§ø ‡§µ‡§ø‡§≠‡§æ‡§ó ‡§∏‡•á ‡§∏‡§≤‡§æ‡§π ‡§≤‡•á‡§Ç‡•§</li>
      <li class="small-note">‡§∞‡§ø‡§´‡§∞‡•á‡§Ç‡§∏: ‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä/ICAR/TNAU/FAO ‡§¶‡§ø‡§∂‡§æ‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂‡•ã‡§Ç ‡§ï‡§æ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‚Äî ‡§®‡•Ä‡§ö‡•á ‡§∏‡§Ç‡§¶‡§∞‡•ç‡§≠ ‡§¶‡§ø‡§è ‡§ó‡§è ‡§π‡•à‡§Ç‡•§</li>
      <li class="small-note warn">‡§µ‡•â‡§á‡§∏ ‡§Æ‡§æ‡§®‡•ç‡§Ø‡§§‡§æ ‡§î‡§∞ ‡§Ü‡§µ‡§æ‡§ú‡§º ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§™‡§∞ ‡§®‡§ø‡§∞‡•ç‡§≠‡§∞ ‡§ï‡§∞‡§§‡•Ä ‡§π‡•à ‚Äî Chrome/Android ‡§∏‡§¨‡§∏‡•á ‡§Ö‡§ö‡•ç‡§õ‡•á ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§ï‡•á ‡§∏‡§æ‡§• ‡§Ü‡§§‡§æ ‡§π‡•à‡•§</li>
    </ul>
  </div>
</main>

<script>
/* ---------------- CONFIG ---------------- */
const OPENWEATHER_API_KEY = "4f64d2ccccb781c20c8cf78bef334ff3"; // demo key (move server-side in production)

/* ---------------- REFERENCE DATA ----------------
   STATE_CROPS: top ~10 common crops per state (short list).
   RATES_PER_HA: Recommended approximate N (kg/ha), P2O5 (kg/ha), K2O (kg/ha).
   --- These are general RDF / blanket recommendations (zone-specific sources exist).
   --- Always prefer soil-test (SHC) based doses; these are starting values for the app.
*/
const RATES_PER_HA = {
  wheat:    { name: "‡§ó‡•á‡§π‡•Ç‡§Å", n:120, p:60, k:40 },
  rice:     { name: "‡§ß‡§æ‡§®", n:150, p:60, k:60 },
  maize:    { name: "‡§Æ‡§ï‡•ç‡§ï‡§æ", n:150, p:60, k:40 },
  cotton:   { name: "‡§ï‡§™‡§æ‡§∏", n:120, p:50, k:60 },
  sugarcane:{ name: "‡§ó‡§®‡•ç‡§®‡§æ", n:300, p:100, k:150 },
  mustard:  { name: "‡§∏‡§∞‡§∏‡•ã‡§Ç / ‡§∞‡§æ‡§™‡§∏‡•Ä‡§°", n:60, p:40, k:40 },
  pulses:   { name: "‡§¶‡§æ‡§≤‡•á‡§Ç (‡§Æ‡§ø‡§∂‡•ç‡§∞‡§ø‡§§)", n:20, p:40, k:20 },
  vegetables:{ name: "‡§∏‡§¨‡•ç‡§ú‡§ø‡§Ø‡§æ‡§Å (‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø)", n:200, p:100, k:100 },
  soybean:  { name: "‡§∏‡•ã‡§Ø‡§æ‡§¨‡•Ä‡§®", n:25, p:80, k:40 },
  groundnut:{ name: "‡§Æ‡•Ç‡§Ç‡§ó‡§´‡§≤‡•Ä", n:20, p:40, k:60 },
  potato:   { name: "‡§Ü‡§≤‡•Ç", n:150, p:90, k:120 },
  tea:      { name: "‡§ö‡§æ‡§Ø", n:150, p:50, k:150 },
  coffee:   { name: "‡§ï‡•â‡§´‡§º‡•Ä", n:50, p:20, k:60 },
  jute:     { name: "‡§ú‡•Ç‡§ü", n:60, p:40, k:40 },
  bajra:    { name: "‡§¨‡§æ‡§ú‡§∞‡§æ", n:40, p:20, k:20 },
  sorghum:  { name: "‡§ú‡•ç‡§µ‡§æ‡§∞ / ‡§ú‡•ç‡§µ‡§æ‡§∞", n:80, p:40, k:40 },
  banana:   { name: "‡§ï‡•á‡§≤‡§æ", n:300, p:225, k:400 },
  coconut:  { name: "‡§®‡§æ‡§∞‡§ø‡§Ø‡§≤", n:300, p:75, k:750 },
  sesame:   { name: "‡§§‡§ø‡§≤", n:20, p:40, k:20 },
  sunflower:{ name: "‡§∏‡•Ç‡§∞‡§ú‡§Æ‡•Å‡§ñ‡•Ä", n:60, p:40, k:20 }
};

/* State -> list of crop keys (order roughly by importance) */
const STATE_CROPS = {
  uttar_pradesh: ['wheat','rice','sugarcane','maize','potato','vegetables','mustard','pulses','cotton','jute'],
  maharashtra:   ['cotton','soybean','sugarcane','groundnut','maize','wheat','bajra','sorghum','pulses','vegetables'],
  bihar:         ['rice','wheat','maize','sugarcane','jute','pulses','potato','mustard','vegetables','sesame'],
  west_bengal:   ['rice','potato','jute','sugarcane','maize','mustard','vegetables','pulses','banana','tea'],
  madhya_pradesh:['soybean','wheat','pulses','maize','cotton','mustard','groundnut','sorghum','vegetables','potato'],
  tamil_nadu:    ['rice','sugarcane','cotton','groundnut','banana','vegetables','maize','pulses','tea','coconut'],
  karnataka:     ['rice','maize','sugarcane','cotton','groundnut','soybean','vegetables','coffee','banana','potato'],
  gujarat:       ['groundnut','cotton','wheat','maize','pulses','sugarcane','mustard','vegetables','sesame','potato'],
  rajasthan:     ['wheat','bajra','maize','mustard','pulses','vegetables','groundnut','sorghum','potato','cotton'],
  andhra_pradesh:['rice','maize','groundnut','cotton','sugarcane','vegetables','soybean','banana','pulses','potato'],
  odisha:        ['rice','maize','groundnut','pulses','sugarcane','vegetables','jute','banana','mustard','potato'],
  telangana:     ['paddy','maize','cotton','groundnut','vegetables','sorghum','pulses','sugarcane','soybean','banana'].map(k=>k==='paddy'?'rice':k),
  assam:         ['rice','tea','jute','pulses','groundnut','vegetables','sugarcane','mustard','banana','potato'],
  punjab:        ['wheat','rice','cotton','sugarcane','maize','vegetables','potato','mustard','pulses','fruit'].map(k=>k==='fruit'?'banana':k),
  haryana:       ['wheat','rice','cotton','sugarcane','maize','mustard','vegetables','pulses','potato','groundnut'],
  kerala:        ['paddy','coconut','rubber','tea','coffee','banana','vegetables','spices','pepper','plantation'].map(k=>{ if(k==='paddy')return 'rice'; if(k==='plantation')return 'coffee'; return k==='coconut'?'coconut':k; }),
  jammu_kashmir: ['paddy','maize','wheat','saffron','potato','vegetables','fruits','pulses','mustard','alfalfa'].map(k=> k==='paddy'?'rice': (k==='fruits'?'banana':k)),
  uttarakhand:   ['wheat','paddy','maize','sugarcane','vegetables','potato','pulses','millet','mustard','fruits'].map(k=>k==='paddy'?'rice':(k==='millet'?'bajra':k)),
  jharkhand:     ['rice','maize','pulses','oilseeds','vegetables','sugarcane','potato','groundnut','jute','fruit'].map(k=>k==='oilseeds'?'groundnut':(k==='fruit'?'banana':k)),
  chhattisgarh:  ['rice','maize','pulses','sugarcane','vegetables','mustard','groundnut','cotton','jute','potato'],
  himachal_pradesh:['maize','wheat','apple','potato','vegetables','pulses','oilseeds','tea','mustard','fruit'].map(k=>k==='apple'?'banana':(k==='fruit'?'banana':k)),
  goa:           ['rice','cashew','coconut','vegetables','banana','arecanut','spices','pulses','groundnut','sugarcane'],
  manipur:       ['rice','maize','pulses','vegetables','potato','oilseeds','banana','sugarcane','groundnut','tea'],
  meghalaya:     ['rice','maize','potato','vegetables','pulses','tea','banana','arecanut','rubber','groundnut'],
  mizoram:       ['rice','maize','pulses','vegetables','banana','potato','tea','groundnut','jute','sugarcane'],
  nagaland:      ['rice','maize','groundnut','pulses','vegetables','sugarcane','banana','tea','potato','jute'],
  tripura:       ['rice','maize','sugarcane','rubber','tea','banana','vegetables','pulses','potato','groundnut'],
  sikkim:        ['paddy','maize','cardamom','potato','vegetables','tea','pulses','fruits','buckwheat','mustard'].map(k=>k==='paddy'?'rice':(k==='fruits'?'banana':k)),
};

/* ---------------- Unit conversions ---------------- */
const ACRE_TO_HA = 0.40468564224;

/* ---------------- Helper utilities ---------------- */
function el(id){ return document.getElementById(id); }
function showResult(html){ el('resultBox').innerHTML = html; }
function showWeather(html){ el('weatherBox').innerHTML = html; }

/* ---------------- Populate crops on state change ---------------- */
const stateSelect = el('state'), cropSelect = el('crop');
stateSelect.addEventListener('change', ()=>{
  const st = stateSelect.value;
  cropSelect.innerHTML = '<option value="">-- ‡§´‡§∏‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç --</option>';
  if(!st || !STATE_CROPS[st]) return;
  const list = STATE_CROPS[st];
  for(const c of list){
    const key = c.toString();
    // prefer readable name
    const label = (RATES_PER_HA[key] && RATES_PER_HA[key].name) ? RATES_PER_HA[key].name : capitalize(key.replace(/_/g,' '));
    const opt = document.createElement('option');
    opt.value = key;
    opt.innerText = label;
    cropSelect.appendChild(opt);
  }
});

function goBack(){
  if(document.referrer){
    window.history.back();
  } else {
    window.location.href = "index.html"; // fallback page if no history
  }
}

/* show custom unit row */
const unitSelect = el('unit'), customRow = el('customRow'), customFactorInput = el('customFactor');
unitSelect.addEventListener('change', ()=>{
  if(unitSelect.value === 'other'){
    customRow.style.display = 'block';
  } else {
    customRow.style.display = 'none';
  }
});

/* ---------------- Area conversion ---------------- */
function areaToHectares(value, unit){
  value = Number(value) || 0;
  if(unit === 'other'){
    const f = Number(customFactorInput.value);
    if(!f || f <= 0) return NaN;
    // customFactor = acres per unit
    return value * f * ACRE_TO_HA;
  }
  if(unit === 'acre') return value * ACRE_TO_HA;
  if(unit === 'hectare') return value;
  if(unit === 'bigha_punjab') return value * 0.625 * ACRE_TO_HA;
  if(unit === 'bigha_up') return value * 0.25 * ACRE_TO_HA;
  if(unit === 'nali') return value * 0.025 * ACRE_TO_HA;
  return NaN;
}

/* ---------------- Geo + Weather (kept from original) ---------------- */
async function getLatLonForLocation(location){
  const q = encodeURIComponent(location + ",IN"); // prefer India
  const url = `https://api.openweathermap.org/geo/1.0/direct?q=${q}&limit=1&appid=${OPENWEATHER_API_KEY}`;
  const res = await fetch(url);
  if(!res.ok) return null;
  const json = await res.json();
  if(!json || !json.length) return null;
  return { lat: json[0].lat, lon: json[0].lon, name: json[0].name, state: json[0].state, country: json[0].country };
}

async function getForecast(lat, lon){
  const url = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${OPENWEATHER_API_KEY}&units=metric&lang=hi`;
  const res = await fetch(url);
  if(!res.ok) return null;
  return res.json();
}

function findEarliestSafeDate(forecastJson){
  if(!forecastJson || !forecastJson.list) return { safe: true, date: null, reason: 'Forecast unavailable' };
  const now = Date.now();
  const list = forecastJson.list;
  const horizonMs = 72 * 3600 * 1000;
  const relevant = list.filter(entry => (entry.dt * 1000) >= now && (entry.dt * 1000) <= (now + horizonMs));
  function hasRain(entries){
    for(const e of entries){
      const main = (e.weather && e.weather[0] && e.weather[0].main) ? e.weather[0].main.toLowerCase() : '';
      const desc = (e.weather && e.weather[0] && e.weather[0].description) ? e.weather[0].description.toLowerCase() : '';
      const rainField = e.rain || e.snow;
      if(main.includes('rain') || main.includes('drizzle') || main.includes('thunderstorm') || desc.includes('rain') || rainField) return true;
    }
    return false;
  }
  for(let startIdx=0; startIdx<relevant.length; startIdx++){
    const startTime = relevant[startIdx].dt * 1000;
    const windowEnd = startTime + (24 * 3600 * 1000);
    const windowEntries = relevant.filter(e => (e.dt*1000) >= startTime && (e.dt*1000) < windowEnd);
    if(windowEntries.length === 0) continue;
    if(!hasRain(windowEntries)){
      return { safe: true, date: new Date(startTime), reason: 'No rain predicted in 24h window starting' };
    }
  }
  return { safe: false, date: null, reason: 'Rain predicted in near future' };
}

/* ---------------- Fertilizer calculations ----------------
   We'll compute:
     - total N, P2O5, K2O needed = rates * hectares
     - DAP (kg) = P2O5_needed / 0.46  (DAP ‚âà 18% N, 46% P2O5)
     - N_from_DAP = DAP_kg * 0.18
     - remaining_N = max(0, totalN - N_from_DAP)
     - Urea (kg) = remaining_N / 0.46  (Urea ‚âà 46% N)
     - MOP (kg) = K2O_needed / 0.60   (MOP ‚âà 60% K2O)
   Show both nutrient totals and product weights, and organic alternatives.
*/
function fmt(n){ return (Math.round(n*100)/100).toFixed(2); }

async function calculateAndAdvise(){
  const stateKey = el('state').value;
  const cropKey = el('crop').value;
  const areaVal = Number(el('area').value);
  const unit = el('unit').value;
  const location = el('location').value.trim();

  if(!stateKey){ showResult('<div class="warn">‡§ï‡•É‡§™‡§Ø‡§æ ‡§∞‡§æ‡§ú‡•ç‡§Ø ‡§ö‡•Å‡§®‡•á‡§Ç</div>'); speakHindi('‡§ï‡•É‡§™‡§Ø‡§æ ‡§∞‡§æ‡§ú‡•ç‡§Ø ‡§ö‡•Å‡§®‡•á‡§Ç'); return; }
  if(!cropKey){ showResult('<div class="warn">‡§ï‡•É‡§™‡§Ø‡§æ ‡§´‡§∏‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç</div>'); speakHindi('‡§ï‡•É‡§™‡§Ø‡§æ ‡§´‡§∏‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç'); return; }
  if(!areaVal || areaVal <=0){ showResult('<div class="warn">‡§ï‡•É‡§™‡§Ø‡§æ ‡§ú‡§Æ‡•Ä‡§® ‡§ï‡•Ä ‡§∏‡§π‡•Ä ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ ‡§°‡§æ‡§≤‡•á‡§Ç</div>'); speakHindi('‡§ï‡•É‡§™‡§Ø‡§æ ‡§ú‡§Æ‡•Ä‡§® ‡§ï‡•Ä ‡§∏‡§π‡•Ä ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ ‡§°‡§æ‡§≤‡•á‡§Ç'); return; }

  const ha = areaToHectares(areaVal, unit);
  if(!ha || isNaN(ha)){ showResult('<div class="warn">‡§ï‡§∏‡•ç‡§ü‡§Æ ‡§á‡§ï‡§æ‡§à ‡§ï‡§æ ‡§Æ‡§æ‡§® ‡§∏‡§π‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à</div>'); speakHindi('‡§ï‡§∏‡•ç‡§ü‡§Æ ‡§á‡§ï‡§æ‡§à ‡§ï‡§æ ‡§Æ‡§æ‡§® ‡§∏‡§π‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à'); return; }

  const rates = RATES_PER_HA[cropKey];
  if(!rates){ showResult('<div class="warn">‡§á‡§∏ ‡§´‡§∏‡§≤ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§°‡•á‡§ü‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à ‚Äî ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Æ‡•à‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤ ‡§∞‡•Ç‡§™ ‡§∏‡•á NPK ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç</div>'); speakHindi('‡§á‡§∏ ‡§´‡§∏‡§≤ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§°‡•á‡§ü‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à'); return; }

  // totals (nutrients)
  const totalN = rates.n * ha;
  const totalP = rates.p * ha; // P2O5
  const totalK = rates.k * ha; // K2O

  // product conversions (typical commercial nutrients)
  const DAP_P2O5_frac = 0.46; // DAP ‚âà 46% P2O5, also contains ~18% N
  const DAP_N_frac = 0.18;
  const UREA_N_frac = 0.46;
  const MOP_K_frac = 0.60;

  const dapKg = totalP / DAP_P2O5_frac;
  const nFromDap = dapKg * DAP_N_frac;
  const remainingN = Math.max(0, totalN - nFromDap);
  const ureaKg = remainingN / UREA_N_frac;
  const mopKg = totalK / MOP_K_frac;

  // Organic / integrated suggestions (general)
  // FYM approx nutrient: very low NPK - so recommend tons/ha for integrated plan
  const fymSuggestion_t_per_ha = 5; // typical integrated suggestion
  const vermi_t_per_ha = 1; // typical
  const neemcake_kg_per_ha = 100;

  // Weather (geocode + forecast) - show loading
  showWeather('‡§Æ‡•å‡§∏‡§Æ ‡§ñ‡•ã‡§ú‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à... ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§');
  let geo = null;
  try{ geo = await getLatLonForLocation(location); } catch(e){ geo = null; }
  if(!geo){
    showWeather('‡§∏‡•ç‡§•‡§æ‡§® ‡§ñ‡•ã‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‚Äî ‡§∏‡•Ä‡§ß‡•á ‡§∂‡§π‡§∞/‡§ú‡§ø‡§≤‡§æ ‡§ï‡§æ ‡§∏‡§ü‡•Ä‡§ï ‡§®‡§æ‡§Æ ‡§°‡§æ‡§≤‡•á‡§Ç (‡§â‡§¶‡§æ. Ludhiana)');
  } else {
    showWeather(`‡§∏‡•ç‡§•‡§æ‡§®: ${geo.name || location} ${geo.state ? ' - '+geo.state : ''} (${geo.lat.toFixed(3)},${geo.lon.toFixed(3)}) ‚Äî ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø‡§µ‡§æ‡§£‡•Ä ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...`);
  }
  let forecast = null;
  if(geo){
    try{ forecast = await getForecast(geo.lat, geo.lon); } catch(e){ forecast = null; }
  }
  const safeInfo = forecast ? findEarliestSafeDate(forecast) : { safe:true, date:null, reason:'Forecast unavailable' };

  // Compose result
  const cropName = rates.name || cropKey;
  const areaText = `${areaVal} ${getUnitLabel(unit)}`;
  let adviceText = '';
  if(safeInfo.safe){
    if(safeInfo.date){
      const d = safeInfo.date;
      const dateStr = d.toLocaleDateString('hi-IN', { day:'numeric', month:'short' });
      adviceText = `‡§Æ‡•å‡§∏‡§Æ ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞, ${dateStr} ‡§∏‡•á ‡§ñ‡§æ‡§¶ ‡§¶‡•á‡§®‡§æ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§¶‡§ø‡§ñ‡§§‡§æ ‡§π‡•à‡•§`;
    } else {
      adviceText = '‡§Æ‡•å‡§∏‡§Æ ‡§†‡•Ä‡§ï ‡§π‡•à, ‡§Ü‡§™ ‡§Ü‡§ú ‡§ñ‡§æ‡§¶ ‡§¶‡•á ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§';
    }
  } else {
    adviceText = '‡§®‡§ú‡§º‡§¶‡•Ä‡§ï‡•Ä ‡§¶‡§ø‡§®‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§¨‡§æ‡§∞‡§ø‡§∂ ‡§ï‡•Ä ‡§Ü‡§∂‡§Ç‡§ï‡§æ ‡§π‡•à ‚Äî ‡§ï‡•É‡§™‡§Ø‡§æ ‡§¨‡§æ‡§∞‡§ø‡§∂ ‡§ï‡•á ‡§∞‡•Å‡§ï‡§®‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶ (‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ 24 ‡§ò‡§Ç‡§ü‡•á ‡§¨‡§æ‡§¶) ‡§ñ‡§æ‡§¶ ‡§¶‡•á‡§Ç‡•§';
  }

  // build HTML
  let html = `<div style="font-weight:800;margin-bottom:8px">${cropName} ‚Äî ${areaText}</div>`;
  html += `<div>‡§ï‡•Å‡§≤ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞: <strong>${ha.toFixed(3)} ‡§π‡•á‡§ï‡•ç‡§ü‡•á‡§Ø‡§∞</strong></div>`;

  html += `<div style="margin-top:8px"><strong>‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§™‡•ã‡§∑‡§ï ‡§§‡§§‡•ç‡§µ (‡§ï‡•Å‡§≤):</strong></div>`;
  html += `<table><tr><th>‡§™‡•ã‡§∑‡§ï</th><th>‡§ï‡•Å‡§≤ ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (kg)</th></tr>`;
  html += `<tr><td>N (‡§®‡§æ‡§á‡§ü‡•ç‡§∞‡•ã‡§ú‡§®)</td><td>${fmt(totalN)}</td></tr>`;
  html += `<tr><td>P‚ÇÇO‚ÇÖ (‡§´‡•â‡§∏‡•ç‡§´‡•á‡§ü)</td><td>${fmt(totalP)}</td></tr>`;
  html += `<tr><td>K‚ÇÇO (‡§™‡•ã‡§ü‡•á‡§∂‡§ø‡§Ø‡§Æ)</td><td>${fmt(totalK)}</td></tr></table>`;

  html += `<div style="margin-top:8px"><strong>‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®‡§ø‡§§ ‡§â‡§∞‡•ç‡§µ‡§∞‡§ï (‡§™‡•ç‡§∞‡•ã‡§°‡§ï‡•ç‡§ü‡•ç‡§∏):</strong></div>`;
  html += `<table><tr><th>‡§â‡§∞‡•ç‡§µ‡§∞‡§ï</th><th>‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®‡§ø‡§§ ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ</th><th>‡§®‡•ã‡§ü</th></tr>`;
  html += `<tr><td>DAP (18-46-0)</td><td>${fmt(dapKg)} kg</td><td>DAP ‡§∏‡•á P‚ÇÇO‚ÇÖ ‡§Æ‡§ø‡§≤‡•á‡§ó‡§æ; DAP ‡§Æ‡•á‡§Ç ~18% N ‡§≠‡•Ä ‡§π‡•ã‡§§‡§æ ‡§π‡•à‡•§</td></tr>`;
  html += `<tr><td>Urea (46-0-0)</td><td>${fmt(ureaKg)} kg</td><td>Urea ‡§Æ‡•Å‡§ñ‡•ç‡§Ø N ‡§∏‡•ç‡§∞‡•ã‡§§ ‚Äî ‡§ä‡§™‡§∞ DAP ‡§ï‡§æ N ‡§ò‡§ü‡§æ‡§®‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§¨‡§ö‡§æ ‡§π‡•Å‡§Ü N‡•§</td></tr>`;
  html += `<tr><td>MOP / KCl (~60% K‚ÇÇO)</td><td>${fmt(mopKg)} kg</td><td>‡§™‡•ã‡§ü‡§æ‡§∂ ‡§ï‡•á ‡§≤‡§ø‡§è MOP (SOP ‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)‡•§</td></tr>`;
  html += `</table>`;

  html += `<div class="small-note" style="margin-top:8px"><strong>‡§®‡•ã‡§ü:</strong> ‡§Ø‡•á ‡§ó‡§£‡§®‡§æ‡§è‡§Å ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§∞‡•Ç‡§™ ‡§∏‡•á NPK ‡§ï‡•Ä ‡§ú‡§º‡§∞‡•Ç‡§∞‡§§‡•ã‡§Ç ‡§ï‡•ã ‡§¶‡§∞‡•ç‡§∂‡§æ‡§§‡•Ä ‡§π‡•à‡§Ç ‡§î‡§∞ ‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä ‡§ú‡§æ‡§Å‡§ö (SHC) ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§∏‡§Æ‡§æ‡§Ø‡•ã‡§ú‡§ø‡§§ ‡§ï‡•Ä ‡§ú‡§æ‡§®‡•Ä ‡§ö‡§æ‡§π‡§ø‡§è‡•§</div>`;

  html += `<div style="margin-top:8px;font-weight:700;color:#2e7d32">${adviceText}</div>`;

  // organic/integrated suggestions
  html += `<div style="margin-top:10px"><strong>‡§á‡§Ç‡§ü‡•Ä‡§ó‡•ç‡§∞‡•á‡§ü‡•á‡§° / ‡§ë‡§∞‡•ç‡§ó‡•á‡§®‡§ø‡§ï ‡§∏‡•Å‡§ù‡§æ‡§µ (‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø):</strong>`;
  html += `<ul><li>FYM/‡§ï‡§Æ‡•ç‡§™‡•ã‡§∏‡•ç‡§ü: ~${fymSuggestion_t_per_ha} t/ha (‡§è‡§ï‡•ç‡§∏‡•ç‡§ü‡•ç‡§∞‡§æ ‡§ú‡•à‡§µ‡§ø‡§ï ‡§™‡•ã‡§∑‡§£, ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä ‡§∏‡•Å‡§ß‡§æ‡§∞)‡•§</li>`;
  html += `<li>‡§µ‡§∞‡•ç‡§Æ‡•Ä-‡§ï‡§Æ‡•ç‡§™‡•ã‡§∏‡•ç‡§ü: ~${vermi_t_per_ha} t/ha (‡§ú‡§¨ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§π‡•ã)‡•§</li>`;
  html += `<li>‡§®‡•Ä‡§Æ ‡§ï‡•á‡§ï: ~${neemcake_kg_per_ha} kg/ha (N ‡§∏‡•ç‡§∞‡•ã‡§§ + ‡§ï‡•Ä‡§ü‡§∞‡•ã‡§ß‡•Ä ‡§ó‡•Å‡§£)‡•§</li>`;
  html += `<li>‡§Ø‡§¶‡§ø ‡§Ü‡§™ ‡§Ü‡§ß‡§æ RDF ‡§ú‡•à‡§µ‡§ø‡§ï ‡§∏‡•ç‡§∞‡•ã‡§§‡•ã‡§Ç ‡§∏‡•á ‡§¶‡•á‡§®‡§æ ‡§ö‡§æ‡§π‡•á‡§Ç ‡§§‡•ã: 50% RDF (‡§∞‡§æ‡§∏‡§æ‡§Ø‡§®‡§ø‡§ï) + 50% FYM/Vermi + ‡§¨‡§æ‡§Ø‡•ã‡§´‡§∞‡•ç‡§ü‡§ø‡§≤‡§æ‡§á‡§ú‡§º‡§∞ (Rhizobium, PSB) ‡§è‡§ï ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§§‡§∞‡•Ä‡§ï‡§æ ‡§π‡•à‡•§</li>`;
  html += `</ul></div>`;

  // If forecast short summary
  if(forecast && forecast.list && forecast.list.length){
    const soon = forecast.list.slice(0,8);
    const nowWeather = soon[0] && soon[0].weather && soon[0].weather[0] ? soon[0].weather[0].description : '';
    html += `<div class="small-note" style="margin-top:8px">‡§§‡§æ‡§ú‡§º‡§æ ‡§Æ‡•å‡§∏‡§Æ (‡§Ö‡§ó‡§≤‡•á ~24 ‡§ò‡§Ç‡§ü‡•á): ${nowWeather || '‚Äî'}</div>`;
  }

  // Show formulas & conversion notes
  html += `<div class="muted-block"><strong>‡§ï‡•à‡§∏‡•á ‡§ó‡§£‡§®‡§æ ‡§ï‡•Ä ‡§ó‡§à:</strong> ‡§π‡§Æ‡§®‡•á N, P‚ÇÇO‚ÇÖ ‡§î‡§∞ K‚ÇÇO (kg/ha) √ó ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ (ha) ‡§ï‡§∞‡§ï‡•á ‡§ï‡•Å‡§≤ ‡§™‡•ã‡§∑‡§ï ‡§®‡§ø‡§ï‡§æ‡§≤‡•á‡•§</div>`;
  html += `<div class="small-note">‡§â‡§∞‡•ç‡§µ‡§∞‡§ï ‡§∞‡•Ç‡§™‡§æ‡§Ç‡§§‡§∞‡§£ ‡§Æ‡§æ‡§®‡§ï: DAP ‚âà 46% P‚ÇÇO‚ÇÖ ‡§î‡§∞ ‚âà18% N; Urea ‚âà 46% N; MOP ‚âà 60% K‚ÇÇO. (‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§ï‡•á ‡§≤‡§ø‡§è, DAP kg = P‚ÇÇO‚ÇÖ_‡§ï‡•Å‡§≤ / 0.46)‡•§</div>`;

  showResult(html);

  // Speak short summary
  let speakMsg = `${cropName} ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•Å‡§≤ N ${Math.round(totalN)} ‡§ï‡§ø‡§≤‡•ã, P ${Math.round(totalP)} ‡§ï‡§ø‡§≤‡•ã ‡§î‡§∞ K ${Math.round(totalK)} ‡§ï‡§ø‡§≤‡•ã ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•à‡•§ ‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®‡§ø‡§§ DAP ${Math.round(dapKg)} ‡§ï‡§ø‡§≤‡•ã, ‡§Ø‡•Ç‡§∞‡§ø‡§Ø‡§æ ${Math.round(ureaKg)} ‡§ï‡§ø‡§≤‡•ã ‡§î‡§∞ MOP ${Math.round(mopKg)} ‡§ï‡§ø‡§≤‡•ã‡•§ ${adviceText}`;
  speakHindi(speakMsg);
}

/* ---------------- Simple TTS and voice code (kept from original) ---------------- */
let speechUtterance = null;
let speechPaused = false;
function speakHindi(text){
  if(!('speechSynthesis' in window)){ console.warn('TTS unsupported'); return; }
  if(speechSynthesis.speaking){ speechSynthesis.cancel(); }
  speechUtterance = new SpeechSynthesisUtterance(text);
  speechUtterance.lang = 'hi-IN';
  const voices = speechSynthesis.getVoices();
  const hiVoice = voices.find(v => v.lang && v.lang.toLowerCase().startsWith('hi')) ||
                  voices.find(v => v.lang && v.lang.toLowerCase().startsWith('en-in')) ||
                  voices[0];
  if(hiVoice) speechUtterance.voice = hiVoice;
  speechSynthesis.speak(speechUtterance);
  speechPaused = false;
}
function toggleSpeech(){
  if(!('speechSynthesis' in window)) return;
  if(speechSynthesis.speaking){
    if(!speechPaused){
      speechSynthesis.pause(); speechPaused = true; document.getElementById('pauseBtn').innerText = '‚ñ∂Ô∏è Resume';
    } else {
      speechSynthesis.resume(); speechPaused = false; document.getElementById('pauseBtn').innerText = '‚è∏Ô∏è Pause';
    }
  }
}

/* ---------------- Voice recognition (kept and adapted) ---------------- */
let recognizer = null;
let listening = false;
function toggleListening(){
  if(listening){ stopListening(); return; }
  startListening();
}
function stopListening(){
  if(recognizer){
    recognizer.stop();
    recognizer = null;
  }
  const mic = el('micBtn'); mic.classList.remove('listening'); listening = false;
}
function startListening(){
  if(!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)){
    alert('‡§Ø‡§π ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ speech recognition ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ Chrome ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç‡•§');
    return;
  }
  const mic = el('micBtn'); mic.classList.add('listening');
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognizer = new SpeechRecognition();
  recognizer.lang = 'hi-IN';
  recognizer.interimResults = false;
  recognizer.maxAlternatives = 1;
  listening = true;
  recognizer.start();

  recognizer.onresult = (evt) => {
    const text = evt.results[0][0].transcript;
    mic.classList.remove('listening'); listening = false;
    showResult(`<div class="muted">‡§Ü‡§™‡§®‡•á ‡§ï‡§π‡§æ: ${text}</div>`);
    parseVoiceText(text);
  };

  recognizer.onerror = (ev) => {
    const mic = el('micBtn'); mic.classList.remove('listening'); listening = false;
    const err = ev.error || 'unknown';
    showResult(`<div class="warn">‡§µ‡•â‡§á‡§∏ ‡§á‡§®‡§™‡•Å‡§ü ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${err}</div>`);
    speakHindi('‡§Æ‡§æ‡§´ ‡§ï‡•Ä‡§ú‡§ø‡§è, ‡§Æ‡•à‡§Ç ‡§∏‡§Æ‡§ù ‡§®‡§π‡•Ä‡§Ç ‡§™‡§æ‡§Ø‡§æ‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§¶‡•ã‡§¨‡§æ‡§∞‡§æ ‡§¨‡•ã‡§≤‡•á‡§Ç ‡§Ø‡§æ ‡§Æ‡•à‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§á‡§®‡§™‡•Å‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§');
  };
  recognizer.onend = () => { const mic = el('micBtn'); mic.classList.remove('listening'); listening = false; };
}

/* Very simple parser ‚Äî improved to detect state/crop/area */
function parseVoiceText(text){
  text = text.toLowerCase();
  const numMatch = text.match(/(\d+(\.\d+)?)/);
  if(numMatch){ el('area').value = numMatch[1]; }

  // detect units
  if(text.includes('‡§è‡§ï‡§°‡§º') || text.includes('‡§è‡§ï‡§°')) el('unit').value = 'acre';
  else if(text.includes('‡§π‡•á‡§ï‡•ç‡§ü‡•á‡§Ø‡§∞')) el('unit').value = 'hectare';
  else if(text.includes('‡§¨‡•Ä‡§ò‡§æ') || text.includes('‡§¨‡§ø‡§ò‡§æ')) {
    if(text.includes('‡§™‡§Ç‡§ú‡§æ‡§¨') || text.includes('‡§™‡§Ç‡§ú‡§æ‡§¨‡•Ä')) el('unit').value = 'bigha_punjab';
    else if(text.includes('‡§â‡§™‡•ç‡§∞') || text.includes('‡§Ø‡•Ç‡§™‡•Ä')) el('unit').value = 'bigha_up';
    else el('unit').value = 'bigha_punjab';
  } else if(text.includes('‡§®‡§æ‡§≤‡•Ä') || text.includes('‡§®‡§≤')) el('unit').value = 'nali';

  // detect state names (simple heuristics)
  const stateMap = {
    '‡§â‡§§‡•ç‡§§‡§∞ ‡§™‡•ç‡§∞‡§¶‡•á‡§∂':'uttar_pradesh','‡§Æ‡§π‡§æ‡§∞‡§æ‡§∑‡•ç‡§ü‡•ç‡§∞':'maharashtra','‡§¨‡§ø‡§π‡§æ‡§∞':'bihar','‡§™‡§∂‡•ç‡§ö‡§ø‡§Æ ‡§¨‡§Ç‡§ó‡§æ‡§≤':'west_bengal','‡§Æ‡§ß‡•ç‡§Ø ‡§™‡•ç‡§∞‡§¶‡•á‡§∂':'madhya_pradesh',
    '‡§§‡§Æ‡§ø‡§≤‡§®‡§æ‡§°‡•Å':'tamil_nadu','‡§§‡§Æ‡§ø‡§≤ ‡§®‡§æ‡§°‡•Å':'tamil_nadu','‡§ï‡§∞‡•ç‡§®‡§æ‡§ü‡§ï':'karnataka','‡§ó‡•Å‡§ú‡§∞‡§æ‡§§':'gujarat','‡§∞‡§æ‡§ú‡§∏‡•ç‡§•‡§æ‡§®':'rajasthan',
    '‡§Ü‡§Ç‡§ß‡•ç‡§∞ ‡§™‡•ç‡§∞‡§¶‡•á‡§∂':'andhra_pradesh','‡§ì‡§°‡§ø‡§∂‡§æ':'odisha','‡§§‡•á‡§≤‡§Ç‡§ó‡§æ‡§®‡§æ':'telangana','‡§Ö‡§∏‡§Æ':'assam','‡§™‡§Ç‡§ú‡§æ‡§¨':'punjab',
    '‡§π‡§∞‡§ø‡§Ø‡§æ‡§£‡§æ':'haryana','‡§ï‡•á‡§∞‡§≤':'kerala','‡§ú‡§Æ‡•ç‡§Æ‡•Ç':'jammu_kashmir','‡§â‡§§‡•ç‡§§‡§∞‡§æ‡§ñ‡§Ç‡§°':'uttarakhand','‡§ù‡§æ‡§∞‡§ñ‡§Ç‡§°':'jharkhand',
    '‡§õ‡§§‡•ç‡§§‡•Ä‡§∏‡§ó‡§¢‡§º':'chhattisgarh','‡§π‡§ø‡§Æ‡§æ‡§ö‡§≤':'himachal_pradesh','‡§ó‡•ã‡§µ‡§æ':'goa','‡§Æ‡§£‡§ø‡§™‡•Å‡§∞':'manipur','‡§Æ‡•á‡§ò‡§æ‡§≤‡§Ø':'meghalaya','‡§Æ‡§ø‡§ú‡•ã‡§∞‡§Æ':'mizoram',
    '‡§®‡§æ‡§ó‡§æ‡§≤‡•à‡§Ç‡§°':'nagaland','‡§§‡•ç‡§∞‡§ø‡§™‡•Å‡§∞‡§æ':'tripura','‡§∏‡§ø‡§ï‡•ç‡§ï‡§ø‡§Æ':'sikkim'
  };
  Object.keys(stateMap).forEach(n=>{
    if(text.includes(n.toLowerCase())){
      el('state').value = stateMap[n];
      // trigger crop population
      stateSelect.dispatchEvent(new Event('change'));
    }
  });

  // detect crop names (search through RATES_PER_HA names)
  const cropKeys = Object.keys(RATES_PER_HA);
  for(const k of cropKeys){
    const name = RATES_PER_HA[k].name.toLowerCase();
    if(text.includes(name) || text.includes(k)) {
      el('crop').value = k;
      break;
    }
  }

  // try to detect location (last token heuristic)
  const words = text.split(/\s+/).filter(Boolean);
  if(words.length){
    const last = words[words.length -1];
    if(!/^\d+(\.\d+)?$/.test(last)){
      const excluded = ['‡§è‡§ï‡§°‡§º','‡§π‡•á‡§ï‡•ç‡§ü‡•á‡§Ø‡§∞','‡§¨‡•Ä‡§ò‡§æ','‡§®‡§æ‡§≤‡•Ä','‡§ï‡•á','‡§ï‡§æ','‡§ï‡•Ä','‡§Æ‡•á‡§Ç','‡§≤‡§ø‡§è','‡§î‡§∞'];
      if(!excluded.includes(last)) el('location').value = capitalize(last);
    }
  }

  setTimeout(()=> calculateAndAdvise(), 900);
}

function capitalize(s){ return s && s.length ? s.charAt(0).toUpperCase()+s.slice(1) : s; }

/* Helper get label */
function getUnitLabel(unit){
  const map = {
    acre: "‡§è‡§ï‡§°‡§º",
    hectare: "‡§π‡•á‡§ï‡•ç‡§ü‡•á‡§Ø‡§∞",
    bigha_punjab: "‡§¨‡•Ä‡§ò‡§æ (Punjab)",
    bigha_up: "‡§¨‡•Ä‡§ò‡§æ (UP)",
    nali: "‡§®‡§æ‡§≤‡•Ä",
    other: "‡§Ø‡•Ç‡§®‡§ø‡§ü"
  };
  return map[unit] || unit;
}

/* ensure voices loaded */
if('speechSynthesis' in window){
  window.speechSynthesis.onvoiceschanged = ()=>{ /* noop */ };
}

customFactorInput.placeholder = "‡§â‡§¶‡§æ‡§π‡§∞‡§£: 0.625 (1 bigha = 0.625 acre)";
</script>
</body>
</html>